name: CI

on:
  push:
    branches-ignore: [ "main" ]
    paths-ignore:
      - '**.md'
  pull_request:
    types: [opened, reopened]
    branches: [ "*" ]
    paths-ignore:
      - '**.md'

  # Adds ability to run this workflow manually
  workflow_dispatch:


jobs:
  yamllint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ibiqlik/action-yamllint@v3
        with:
          file_or_dir: "docker-compose.yml"


  shellcheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ludeeus/action-shellcheck@2.0.0
        with:
          scandir: '.'
          severity: error


  build-influxdb-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create .env for CI
        run: |
          cat > .env <<'EOF'
          INFLUXDB_INIT_USERNAME=ciadmin
          INFLUXDB_INIT_PASSWORD=CiAdmin1234
          INFLUXDB_ORG=ci-org
          INFLUXDB_BUCKET=ci-bucket
          INFLUXDB_TOKEN=ci-token-super-secret
          EOF

      - name: Start InfluxDB only
        run: docker compose up -d influxdb

      - name: Wait for InfluxDB to be ready
        run: |
          # Poll from a curl container
          for i in {1..60}; do
            if docker run --rm --network "$(docker compose ps -q influxdb | xargs docker inspect -f '{{range .NetworkSettings.Networks}}{{.NetworkID}}{{end}}' | head -n1)" \
              curlimages/curl:8.5.0 -fsS http://influxdb:8086/health >/dev/null; then
              echo "InfluxDB /health is OK"
              break
            fi
            echo "Waiting for InfluxDB... ($i/60)"
            sleep 2
          done

      - name: Show container logs on failure
        if: failure()
        run: docker compose logs --no-color influxdb

      - name: Teardown
        if: always()
        run: docker compose down -v
